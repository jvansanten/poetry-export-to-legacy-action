# Export poetry to legacy formats

Do you like using [poetry](https://python-poetry.org) for packaging, but also like being able to install a project with `pip install -e`? This action uses `poetry` and `create_setup.py` (from [flicamera](https://github.com/sdss/flicamera)) to generate `setup.py` and `requirements.txt` from `pyproject.toml`.

## Usage example

This action can be combined with [create-pull-request](https://github.com/marketplace/actions/create-pull-request) to keep `setup.py` and `requirements.txt` in sync with `pyproject.toml`.

```yaml
name: ci

on:
  push:
    branches-ignore:
      update-setup

jobs:
  artifacts:
    runs-on: ubuntu-18.04

    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - uses: jvansanten/poetry-export-to-legacy-action@master
    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v3
      with:
        commit-message: Update legacy package
        committer: GitHub <noreply@github.com>
        author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
        signoff: false
        branch: update-setup
        delete-branch: true
        title: 'Update setup.py and friends'

```
## Using setup.py and poetry in parallel

Note that `pip` will automatically use [PEP 517](https://www.python.org/dev/peps/pep-0517/) mode when a `pyproject.toml` is present.  This means that `setup.py` will be invoked in a virtual environment where only the build system requirements explicitly listed in `pyproject.toml` are present, leading to a confusing error message if you use the default `pyproject.toml` generated by `poetry init`: 

```
  Running setup.py develop for ampel-interface
    ERROR: Command errored out with exit status 1:
     command: /opt/homebrew/Caskroom/miniforge/base/envs/installtest/bin/python3.8 -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/Users/jakob/src/ampel-interface/setup.py'"'"'; __file__='"'"'/Users/jakob/src/ampel-interface/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' develop --no-deps
         cwd: /Users/jakob/src/ampel-interface/
    Complete output (3 lines):
    Traceback (most recent call last):
      File "<string>", line 1, in <module>
    ModuleNotFoundError: No module named 'setuptools'
```

To work around this, you should require both `setuptools` and `poetry-core` in the `build-system` section, even though a `poetry` build does not require `setuptools`:

```toml
[build-system]
requires = ["poetry-core>=1.0.0", "setuptools>=40.8.0"]
build-backend = "poetry.core.masonry.api"
```